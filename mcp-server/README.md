# Tyaprover MCP Server for Claude Code CLI

**Version 2.0.0 - AI-Powered Application Deployment and Management**

This MCP (Model Context Protocol) server enables natural language control of your Tyaprover instance through Claude Code CLI. Deploy, manage, and monitor your applications using conversational commands instead of complex CLI syntax.

## What's New in v2.0.0 üéâ

**Major Architecture Overhaul** - Complete modular redesign with 66 total tools:
- **57 Core MCP Tools** covering 86% of CapRover API
- **9 Citizen Developer Automation Tools** for non-technical users
- **Modular Architecture** - One file per tool (93% code reduction)
- **Auto-Discovery System** - Zero-config tool loading

See [CHANGELOG](../CHANGELOG.md) for complete v2.0.0 details.

## üöÄ Quick Start

### 1. Install Dependencies
```bash
npm install
```

### 2. Build the Server
```bash
npm run build
```

### 3. Configure Environment
```bash
# Copy example configuration
cp .env.example .env

# Edit .env with your settings
export TYAPROVER_API_URL="https://captain.toowired.win"
export TYAPROVER_AUTH_TOKEN="your-auth-token-here"
export TYAPROVER_NAMESPACE="captain"
```

### 4. Test the Server
```bash
npm test
```

### 5. Configure Claude CLI
Add to your Claude CLI MCP configuration:
```json
{
  "tyaprover": {
    "command": "node",
    "args": ["./build/index.js"],
    "cwd": "/path/to/tyaprover/mcp-server"
  }
}
```

### 6. Start Using AI Commands
```bash
claude "show me all my deployed applications"
claude "deploy a new Node.js app called my-api using node:18"
claude "what's the status of my database application?"
```

<!-- Generated by Copilot -->

## üõ† How It Works

The Tyaprover MCP server acts as an intelligent bridge between Claude Code CLI and your Tyaprover instance:

```
Claude CLI ‚Üê‚Üí MCP Server ‚Üê‚Üí Tyaprover REST API ‚Üê‚Üí Your Applications
```

1. **You speak naturally**: "Deploy a React app called portfolio"
2. **Claude understands**: Parses intent and extracts parameters
3. **MCP server translates**: Converts to Tyaprover API calls
4. **Action happens**: Your app gets deployed
5. **You get feedback**: Success confirmation or error details

## üéØ Available AI Commands

### Application Management
- **"List all my applications"** ‚Üí Shows all deployed apps with status
- **"Show me details for [app-name]"** ‚Üí Detailed app configuration
- **"Deploy a new app called [name] using [image]"** ‚Üí Creates and deploys app

### Natural Language Examples
```bash
# List applications
claude "What apps do I have running?"
claude "Show me my deployed services"

# Get app information
claude "Tell me about my API server"
claude "What's the configuration of my database?"

# Deploy new applications
claude "Deploy nginx as a load balancer called gateway"
claude "Create a MongoDB service using mongo:latest"
claude "Deploy a Python Flask app called user-service"
```

See [API.md](./API.md) for complete tool documentation.

## üìã Prerequisites

Before you begin, ensure you have:

### System Requirements
- **Node.js 18+** and npm
- **Running Tyaprover Instance** (accessible over network)
- **Claude Code CLI** (`npm install -g @anthropic-ai/claude-code`)
- **Valid Auth Token** for your Tyaprover instance

### Getting Your Auth Token
1. Log into Tyaprover web interface
2. Open browser developer tools (F12)
3. Go to Network tab
4. Make any action (like viewing apps)
5. Find a request and copy the `x-captain-auth` header value

<!-- Generated by Copilot -->

## Setup and Running the Tyaprover MCP Server

The MCP server is typically launched automatically by the Claude Code CLI based on your `mcp-config.json`. However, you'll need to build it first.

1.  **Navigate to the MCP Server Directory:**
    ```bash
    cd /path/to/your/caprover-project/mcp-server/
    ```

2.  **Install Dependencies:**
    ```bash
    npm install
    ```

3.  **Build the Server:**
    ```bash
    npm run build
    ```
    This command compiles the TypeScript source code into JavaScript in the `mcp-server/build/` directory and makes the `build/index.js` file executable.

4.  **Manual Testing (Optional):**
    You can test run the server manually to see if it starts, but it won't do much without being called by an MCP client (like Claude CLI).
    ```bash
    # Ensure these are set in your environment for manual testing:
    # export TYAPROVER_API_URL="https://captain.your-domain.com"
    # export TYAPROVER_AUTH_TOKEN="your-auth-token"
    # export TYAPROVER_NAMESPACE="captain"
    npm start
    ```
    You should see a message like "Tyaprover MCP Server running on stdio..." in the console error stream. Press `Ctrl+C` to stop.

## Configuring Claude Code CLI (`mcp-config.json`)

To enable the Claude Code CLI to use your Tyaprover MCP server, you need to create or update an `mcp-config.json` file. This file tells Claude CLI how to launch your server.

**Location:** You can place this file anywhere, for example, in your user's Claude configuration directory (e.g., `~/.claude/mcp-config.json` on Linux/macOS) or in your project directory. You will then specify its path when running `claude`.

**Content:**

```json
{
  "mcpServers": {
    "tyaprover": {
      "command": "node",
      "args": [
        "/absolute/path/to/your/caprover-project/mcp-server/build/index.js"
      ],
      "env": {
        "TYAPROVER_API_URL": "https://captain.your-caprover-domain.com",
        "TYAPROVER_AUTH_TOKEN": "your-long-lived-caprover-auth-token",
        "TYAPROVER_NAMESPACE": "captain",
        "CAPROVER_API_VERSION": "v2"
      }
    }
  }
}
```

**Key fields to customize:**

*   **`command`**: Should generally be `"node"`.
*   **`args[0]`**: **Crucial!** Replace `/absolute/path/to/your/caprover-project/mcp-server/build/index.js` with the correct, absolute path to the compiled `index.js` file of *your* Tyaprover MCP server.
*   **`env.TYAPROVER_API_URL`**: Your Tyaprover instance's base URL (e.g., `http://localhost:3000` or `https://captain.yourdomain.com`).
*   **`env.TYAPROVER_AUTH_TOKEN`**: Your valid `x-captain-auth` token.
*   **`env.TYAPROVER_NAMESPACE`**: Usually `"captain"`.
*   **`env.CAPROVER_API_VERSION`**: The API version your CapRover instance uses (e.g., "v2").

**Usage with Claude CLI:**

```bash
claude --mcp-config /path/to/your/mcp-config.json "Your prompt here"
```
Or, in interactive mode:
```bash
claude --mcp-config /path/to/your/mcp-config.json
> Your prompt for Tyaprover
```

## Available Tools (66 Total)

The Tyaprover MCP server now exposes **66 comprehensive tools** organized in 9 categories:

### Core Tools (57)

**System Management (15 tools)**:
- `getSystemStatus` - System status, version, load balancer info
- `listNodes` - List all cluster nodes
- `addNode` - Add worker node to cluster
- `updateSystem` - Perform system updates
- `getNetData` - NetData monitoring metrics
- And 10 more system management tools...

**Security (7 tools)**:
- `enableSsl` - Enable SSL for root domain
- `forceHttpsOnDomain` - Force HTTPS redirect
- `setFirewallRule` - Configure firewall rules
- `enableRegistryAuth` - Enable Docker registry authentication
- And 3 more security tools...

**Applications (17 tools)**:
- `listApps` - List all applications
- `getAppDetails` - Get detailed app info
- `registerApp` - Register new application
- `deployApp` - Deploy application
- `deleteApp` - Delete application
- `scaleApp` - Scale instance count
- `setAppEnvironmentVariables` - Configure env vars
- `enableAppSsl` - Enable SSL for app
- `rollbackApp` - Rollback to previous version
- And 8 more app management tools...

**Registry (5 tools)**:
- `enableDockerRegistry` - Enable self-hosted registry
- `pushImageToRegistry` - Push image to registry
- `searchRegistryImages` - Search registry images
- `deleteRegistryImage` - Delete registry image
- `getRegistryAuth` - Get registry credentials

**One-Click Apps (3 tools)**:
- `listOneClickApps` - List available templates
- `deployOneClickApp` - Deploy from template
- `getOneClickAppDetails` - Get template details

**Themes (4 tools)**:
- `listThemes` - List UI themes
- `activateTheme` - Activate a theme
- `uploadCustomTheme` - Upload custom theme
- `deleteCustomTheme` - Delete custom theme

**Projects (4 tools)**:
- `listProjects` - List project groups
- `createProject` - Create project group
- `addAppToProject` - Add app to project
- `deleteProject` - Delete project group

**Premium Features (2 tools)**:
- `enableTwoFactorAuth` - Enable 2FA
- `configureBuildAlerts` - Configure build notifications

### Citizen Developer Automation Tools (9)

High-level abstractions for non-technical users:

1. **`quickDeployWebsite`** - Deploy website with SSL in one command
   - Input: `websiteName`, `dockerImage`, optional `customDomain`
   - Auto-configures: SSL, port 80, custom domain

2. **`deployFullStackApp`** - Complete 3-tier application deployment
   - Input: `appName`, `frontendImage`, `backendImage`, `database` type
   - Auto-configures: Database with credentials, inter-service networking, environment variables

3. **`createDevEnvironment`** - Cloud IDE with database & Redis
   - Input: `envName`, `language`, optional `includeDatabase`, `includeRedis`
   - Auto-configures: Code-server (VS Code in browser), PostgreSQL, Redis

4. **`deployFromGitHub`** - Direct GitHub repository deployment
   - Input: `appName`, `githubRepo`, `branch`, `port`
   - Auto-configures: Git integration, auto-deploy on push, webhook

5. **`scaleAppAutomatically`** - Time-based auto-scaling rules
   - Input: `appName`, `rule` (business-hours/always-on), instance counts
   - Auto-configures: Instance scaling based on time patterns

6. **`createBackupSchedule`** - Automated backup configuration
   - Input: `schedule` (daily/weekly/monthly), `includeApps` list
   - Auto-configures: Backup creation, cron schedule recommendations

7. **`healthCheck`** - One-command system diagnostics
   - Input: None
   - Auto-analyzes: System status, app health, SSL status, common issues

8. **`cloneApp`** - Clone apps for staging/testing
   - Input: `sourceApp`, `newAppName`, optional `includeData`
   - Auto-configures: Duplicate configuration, separate volumes

9. **`oneClickWordPress`** - WordPress + MySQL instant deployment
   - Input: `siteName`, optional `customDomain`, `adminEmail`
   - Auto-configures: WordPress, MySQL, database connection, SSL

For complete tool documentation and examples, see:
- [MCP_TOOLS.md](./MCP_TOOLS.md) - Comprehensive tool reference
- [src/tools/README.md](./src/tools/README.md) - Architecture guide
- [src/tools/automation/README.md](./src/tools/automation/README.md) - Citizen developer guide

## Example Prompts

**System Management**:
- `"What's my Tyaprover system status?"`
- `"Show me all nodes in my cluster"`
- `"Enable NetData monitoring"`

**Application Deployment**:
- `"List all my apps"`
- `"Deploy a new app named 'api' using node:18"`
- `"Scale my database app to 3 instances"`
- `"Enable SSL for my website"`

**Citizen Developer Commands** (High-Level):
- `"Quick deploy a website with SSL for my portfolio"`
- `"Deploy a complete full-stack app with React, Node and PostgreSQL"`
- `"Create a dev environment with VS Code and database"`
- `"Deploy WordPress for my blog at blog.example.com"`
- `"Clone my production app to staging"`
- `"Run a health check on my system"`

Claude will interpret your natural language and call the appropriate tools automatically.

## Troubleshooting

*   **"Command not found" or server doesn't start:**
    *   Ensure the `command` and `args` path in `mcp-config.json` correctly point to your executable `mcp-server/build/index.js`.
    *   Make sure `node` is installed and in your PATH.
    *   Check permissions on `mcp-server/build/index.js` (it should be executable, `npm run build` attempts to set this).
*   **Authentication Errors / API Errors:**
    *   Verify `TYAPROVER_API_URL` and `TYAPROVER_AUTH_TOKEN` in `mcp-config.json` are correct and the token is still valid.
    *   The MCP server logs errors to `console.error()`. When Claude CLI runs it, these logs might appear in Claude's own logs or terminal output, depending on Claude CLI's verbosity and error handling. Check the `mcp-server-tyaprover.log` file if using Claude Desktop.
*   **Tool Not Found / Incorrect Parameters:**
    *   Ensure your prompt is clear.
    *   Check the tool definitions in `mcp-server/src/index.ts` if you suspect an issue with how tools are defined or named.
